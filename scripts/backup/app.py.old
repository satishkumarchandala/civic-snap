"""
Urban Issue Reporter Flask Application - Modular Version
Main application factory and configuration
"""
from flask import Flask
import os
import json
from config import config
from models import init_db
import routes
from logger_config import setup_logging
from error_handlers import register_error_handlers

def create_app(config_name='default'):
    """Application factory function"""
    app = Flask(__name__)
    
    # Load configuration
    app.config.from_object(config[config_name])
    
    # Load environment variables if .env exists
    if os.path.exists('.env'):
        try:
            from dotenv import load_dotenv
            load_dotenv()
        except ImportError:
            pass  # python-dotenv not installed
    
    # Setup logging
    setup_logging(app)
    
    # Register error handlers
    register_error_handlers(app)
    
    # Add custom Jinja2 filters
    @app.template_filter('from_json')
    def from_json_filter(value):
        """Convert JSON string to Python object"""
        try:
            if isinstance(value, str):
                return json.loads(value)
            return value
        except (ValueError, TypeError):
            return {}
    
    # Initialize routes
    routes.init_routes(app)
    
    app.logger.info('Flask application initialized successfully')
    
    return app

def main():
    """Main function to run the application"""
    # Create uploads directory if it doesn't exist
    os.makedirs('uploads', exist_ok=True)
    os.makedirs('models', exist_ok=True)  # For ML models
    
    # Initialize database
    init_db()
    
    # Create application
    config_name = os.environ.get('FLASK_ENV', 'development')
    app = create_app(config_name)
    
    # Initialize ML models
    try:
        from ml_models import initialize_ml_models
        from logger_config import get_ml_logger
        
        ml_logger = get_ml_logger()
        ml_logger.info("Initializing ML models...")
        print("ü§ñ Initializing ML models...")
        
        ml_pipeline = initialize_ml_models()
        
        ml_logger.info("ML models initialized successfully")
        print("‚úÖ ML models initialized successfully")
    except ImportError as e:
        app.logger.warning(f"ML models not available: {e}")
        print(f"‚ö†Ô∏è  ML models not available: {e}")
    except Exception as e:
        app.logger.error(f"ML initialization failed: {e}", exc_info=True)
        print(f"‚ö†Ô∏è  ML initialization warning: {e}")
    
    # Print startup information
    app.logger.info('='*80)
    app.logger.info('Database initialized successfully')
    app.logger.info('Starting Urban Issue Reporter Flask App')
    app.logger.info(f"Environment: {config_name}")
    app.logger.info(f"Debug mode: {app.config.get('DEBUG', False)}")
    app.logger.info(f"Host: {app.config.get('HOST', '0.0.0.0')}:{app.config.get('PORT', 5000)}")
    app.logger.info('='*80)
    
    print("\n" + "="*80)
    print("‚úÖ Database initialized successfully")
    print("üöÄ Starting Urban Issue Reporter Flask App...")
    print(f"üåç Environment: {config_name.upper()}")
    print("üåê Open: http://localhost:5000")
    print("üë§ Admin Login: admin@example.com / admin123")
    print("ü§ñ ML Automation: Category classification and priority detection enabled")
    print("üìß Email notifications enabled with Gmail")
    print(f"üìÆ Sending emails from: {app.config['MAIL_USERNAME']}")
    print(f"üìù Logs directory: {os.path.abspath('logs')}")
    print("="*80 + "\n")
    
    # Run the application
    try:
        app.run(
            debug=app.config.get('DEBUG', False),
            host=app.config.get('HOST', '0.0.0.0'),
            port=app.config.get('PORT', 5000)
        )
    except Exception as e:
        app.logger.critical(f"Application failed to start: {e}", exc_info=True)
        raise

if __name__ == '__main__':
    main()

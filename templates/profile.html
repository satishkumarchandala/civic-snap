{% extends "base.html" %}

{% block title %}My Profile - Urban Issue Reporter{% endblock %}

{% block content %}
<div class="container">
    <div class="profile-container">
        <div class="profile-header">
            <div class="profile-avatar">
                {% if user.profile_picture %}
                    <img src="{{ url_for('uploaded_file', filename=user.profile_picture) }}" 
                         alt="Profile Picture" class="profile-image">
                {% else %}
                    <div class="default-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                {% endif %}
            </div>
            <div class="profile-info">
                <h1>{{ user.name }}</h1>
                <p class="profile-email"><i class="fas fa-envelope"></i> {{ user.email }}</p>
                {% if user.location %}
                    <p class="profile-location"><i class="fas fa-map-marker-alt"></i> {{ user.location }}</p>
                {% endif %}
                <p class="profile-role">
                    <i class="fas fa-user-tag"></i> 
                    {% if user.role == 'super_admin' %}Super Admin
                    {% elif user.role == 'org_admin' %}Organization Admin
                    {% elif user.role == 'org_staff' %}Organization Staff
                    {% else %}Citizen{% endif %}
                </p>
                {% if user.created_at %}
                    <p class="profile-joined"><i class="fas fa-calendar-alt"></i> Member since {{ user.created_at[:10] }}</p>
                {% endif %}
            </div>
            <div class="profile-actions">
                {% if not edit_mode %}
                    <a href="{{ url_for('edit_profile') }}" class="btn btn-primary">
                        <i class="fas fa-edit"></i> Edit Profile
                    </a>
                    <button onclick="togglePasswordModal()" class="btn btn-secondary">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                {% endif %}
            </div>
        </div>

        {% if not is_profile_complete %}
        <!-- Profile Completion Warning -->
        <div class="alert alert-warning" style="background: linear-gradient(135deg, #ff9800, #f57c00); color: white; border-radius: 12px; padding: 1.5rem; margin: 2rem 0; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="background: rgba(255, 255, 255, 0.2); padding: 0.5rem; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem;"></i>
                </div>
                <div>
                    <h4 style="margin: 0 0 0.5rem 0; font-weight: bold;">
                        <i class="fas fa-user-edit" style="margin-right: 0.5rem;"></i>
                        Complete Your Profile
                    </h4>
                    <div style="line-height: 1.4;">
                        <p style="margin: 0 0 0.5rem 0;">You must complete your profile before reporting issues.</p>
                        <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">
                            <strong>Missing:</strong> {{ missing_fields | join(', ') }}
                        </p>
                        <a href="{{ url_for('edit_profile') }}" style="display: inline-block; margin-top: 1rem; background: rgba(255, 255, 255, 0.2); color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; transition: background 0.3s;">
                            <i class="fas fa-edit"></i> Complete Profile Now
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if not edit_mode %}
            <!-- Profile View Mode -->
            <div class="profile-content">
                <div class="profile-section">
                    <h3><i class="fas fa-info-circle"></i> About</h3>
                    {% if user.bio %}
                        <p class="profile-bio">{{ user.bio }}</p>
                    {% else %}
                        <p class="profile-bio-empty">No bio provided yet.</p>
                    {% endif %}
                </div>

                {% if user.phone %}
                <div class="profile-section">
                    <h3><i class="fas fa-phone"></i> Contact Information</h3>
                    <p><i class="fas fa-mobile-alt"></i> {{ user.phone }}</p>
                </div>
                {% endif %}

                <div class="profile-section">
                    <h3><i class="fas fa-chart-bar"></i> Activity</h3>
                    <div class="activity-stats">
                        <div class="stat-item">
                            <span class="stat-number">{{ user_issues_count or 0 }}</span>
                            <span class="stat-label">Issues Reported</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">{{ user_comments_count or 0 }}</span>
                            <span class="stat-label">Comments</span>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- Profile Edit Mode -->
            <div class="profile-edit-form">
                <h2><i class="fas fa-user-edit"></i> Edit Profile</h2>
                <form method="POST" enctype="multipart/form-data" class="profile-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="name"><i class="fas fa-user"></i> Name *</label>
                            <input type="text" id="name" name="name" value="{{ user.name }}" required>
                        </div>
                        <div class="form-group">
                            <label for="phone"><i class="fas fa-phone"></i> Phone</label>
                            <input type="tel" id="phone" name="phone" value="{{ user.phone or '' }}">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="location"><i class="fas fa-map-marker-alt"></i> Location</label>
                            <input type="text" id="location" name="location" value="{{ user.location or '' }}">
                        </div>
                        <div class="form-group">
                            <label for="profile_picture"><i class="fas fa-image"></i> Profile Picture</label>
                            <input type="file" id="profile_picture" name="profile_picture" accept="image/*" onchange="previewProfileImage(this)">
                            <div class="file-preview" id="profileImagePreview">
                                {% if user.profile_picture %}
                                    <img src="{{ url_for('uploaded_file', filename=user.profile_picture) }}" alt="Current Profile Picture">
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="bio"><i class="fas fa-pen"></i> Bio</label>
                        <textarea id="bio" name="bio" rows="4" placeholder="Tell us about yourself...">{{ user.bio or '' }}</textarea>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <a href="{{ url_for('profile') }}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        {% endif %}
    </div>
</div>

<!-- Password Change Modal -->
<div id="passwordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-key"></i> Change Password</h2>
            <span class="close" onclick="togglePasswordModal()">&times;</span>
        </div>
        <form id="passwordForm" class="password-form">
            <div class="form-group">
                <label for="current_password">Current Password</label>
                <input type="password" id="current_password" name="current_password" required>
            </div>
            <div class="form-group">
                <label for="new_password">New Password</label>
                <input type="password" id="new_password" name="new_password" required minlength="6">
            </div>
            <div class="form-group">
                <label for="confirm_password">Confirm New Password</label>
                <input type="password" id="confirm_password" name="confirm_password" required minlength="6">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Change Password
                </button>
                <button type="button" class="btn btn-secondary" onclick="togglePasswordModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Password modal functions
function togglePasswordModal() {
    const modal = document.getElementById('passwordModal');
    modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
}

// Handle password change form submission
document.getElementById('passwordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/profile/change-password', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Password changed successfully!');
            togglePasswordModal();
            this.reset();
        } else {
            alert(data.message || 'Error changing password');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while changing password');
    });
});

// Profile image preview
function previewProfileImage(input) {
    const preview = document.getElementById('profileImagePreview');
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" alt="Profile Preview">`;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('passwordModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
}
</script>
{% endblock %}
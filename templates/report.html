{% extends "base.html" %}

{% block title %}Report Issue - Urban Issue Reporter{% endblock %}

{% block content %}
<div class="container">
    <div style="max-width: 800px; margin: 2rem auto;">
        <div class="card">
            <div style="text-align: center; margin-bottom: 2rem;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #667eea; margin-bottom: 1rem;"></i>
                <h1>Report New Issue</h1>
                <p style="color: #666;">Help improve your community by reporting urban issues</p>
            </div>
            
            <form method="POST" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="title">
                        <i class="fas fa-heading"></i> Issue Title *
                    </label>
                    <input type="text" id="title" name="title" class="form-control" 
                           placeholder="Brief, descriptive title of the issue" required>
                </div>
                
                <!-- ML Predictions Section -->
                <div id="mlPredictions" class="alert alert-info" style="display: none; margin: 1rem 0;">
                    <h6><i class="fas fa-robot"></i> AI Suggestions</h6>
                    <div id="mlPredictionContent"></div>
                    <small class="text-muted">These are AI-generated suggestions. You can override them manually.</small>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="category">
                            <i class="fas fa-tags"></i> Category *
                        </label>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="getMLPredictions()" title="Get AI suggestions" style="margin-left: 10px;">
                            <i class="fas fa-magic"></i> Auto-suggest
                        </button>
                        <select id="category" name="category" class="form-control" required>
                            <option value="">Select Category</option>
                            <option value="road">üõ£Ô∏è Road</option>
                            <option value="transport">ÔøΩ Transport</option>
                            <option value="sanitation">üóëÔ∏è Sanitation</option>
                            <option value="infrastructure">üèóÔ∏è Infrastructure</option>
                            <option value="water">üíß Water</option>
                            <option value="electricity">‚ö° Electricity</option>
                            <option value="environment">üå± Environment</option>
                            <option value="other">üìã Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="priority">
                            <i class="fas fa-exclamation"></i> Priority
                        </label>
                        <select id="priority" name="priority" class="form-control">
                            <option value="low">üü¢ Low</option>
                            <option value="medium" selected>üü° Medium</option>
                            <option value="high">üü† High</option>
                            <option value="urgent">üî¥ Urgent</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="description">
                        <i class="fas fa-align-left"></i> Description *
                    </label>
                    <textarea id="description" name="description" class="form-control textarea" 
                              placeholder="Detailed description of the issue..." required></textarea>
                </div>
                
                <!-- Location Section -->
                <div style="margin: 2rem 0; padding: 1.5rem; background: #f8f9fa; border-radius: 15px;">
                    <h3 style="margin-bottom: 1rem; color: #333;">
                        <i class="fas fa-map-marker-alt"></i> Location Information
                    </h3>
                    
                    <div class="form-group">
                        <label for="address">
                            <i class="fas fa-home"></i> Address *
                        </label>
                        <input type="text" id="address" name="address" class="form-control" 
                               placeholder="Street address or landmark" required>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="latitude">
                                <i class="fas fa-globe"></i> Latitude *
                            </label>
                            <input type="number" step="any" id="latitude" name="latitude" class="form-control" 
                                   placeholder="e.g., 40.7128" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="longitude">
                                <i class="fas fa-globe-americas"></i> Longitude *
                            </label>
                            <input type="number" step="any" id="longitude" name="longitude" class="form-control" 
                                   placeholder="e.g., -74.0060" required>
                        </div>
                    </div>
                    
                    <button type="button" class="btn" onclick="getCurrentLocation()">
                        <i class="fas fa-crosshairs"></i> Use Current Location
                    </button>
                    
                    <!-- Map -->
                    <div id="map" class="map-container" style="margin-top: 1rem;"></div>
                </div>
                
                <!-- Image Upload -->
                <div class="form-group">
                    <label for="image">
                        <i class="fas fa-camera"></i> Upload Image (Optional)
                    </label>
                    <div class="image-upload" onclick="document.getElementById('image').click()">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #ccc; margin-bottom: 0.5rem;"></i>
                        <p>Click to select an image (PNG, JPG, GIF)</p>
                        <p style="font-size: 0.9rem; color: #666;">Max size: 16MB</p>
                        <input type="file" id="image" name="image" accept="image/*" style="display: none;" onchange="previewImage(this)">
                        <div id="imagePreview"></div>
                    </div>
                </div>
                
                <button type="submit" class="btn" style="width: 100%; font-size: 1.2rem; padding: 1rem;">
                    <i class="fas fa-paper-plane"></i> Submit Issue Report
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize map
let map = L.map('map').setView([20.5937, 78.9629], 5); // India center
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let marker;

// Helper function for reverse geocoding
function updateAddressFromCoordinates(lat, lng) {
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('address').value = data.display_name;
        })
        .catch(error => console.log('Geocoding error:', error));
}

// Helper function to create draggable marker with event handlers
function createDraggableMarker(lat, lng) {
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lng], {draggable: true}).addTo(map);
    
    // Handle marker drag end event
    marker.on('dragend', function(e) {
        const newLat = e.target.getLatLng().lat;
        const newLng = e.target.getLatLng().lng;
        
        document.getElementById('latitude').value = newLat;
        document.getElementById('longitude').value = newLng;
        
        // Update address based on new position
        updateAddressFromCoordinates(newLat, newLng);
    });
}

// Get current location
function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            // Update map
            map.setView([lat, lng], 15);
            createDraggableMarker(lat, lng);
            
            // Update address
            updateAddressFromCoordinates(lat, lng);
        }, function(error) {
            alert('Unable to get your location. Please enter manually.');
        });
    } else {
        alert('Geolocation is not supported by this browser.');
    }
}

// Map click handler
map.on('click', function(e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;
    
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lng;
    
    createDraggableMarker(lat, lng);
    
    // Update address based on clicked position
    updateAddressFromCoordinates(lat, lng);
});

// Image preview
function previewImage(input) {
    const preview = document.getElementById('imagePreview');
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" class="image-preview" alt="Preview">`;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// ML Predictions functionality
function getMLPredictions() {
    const title = document.getElementById('title').value;
    const description = document.getElementById('description').value;
    
    if (!title && !description) {
        alert('Please enter a title and description first to get AI suggestions');
        return;
    }
    
    const mlDiv = document.getElementById('mlPredictions');
    const contentDiv = document.getElementById('mlPredictionContent');
    
    // Show brief loading (will be hidden quickly)
    mlDiv.style.display = 'block';
    contentDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Applying suggestions...';
    
    // Make API call
    fetch(`/api/ml/predict?title=${encodeURIComponent(title)}&description=${encodeURIComponent(description)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const predictions = data.predictions;
                
                // Silently apply the predictions to the form
                document.getElementById('category').value = predictions.category.category;
                document.getElementById('priority').value = predictions.priority.priority;
                
                // Hide the predictions panel
                hidePredictions();
                
            } else {
                // Silently fail - just hide the loading message
                hidePredictions();
            }
        })
        .catch(error => {
            contentDiv.innerHTML = `
                <div class="text-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Error getting AI suggestions: ${error.message}
                </div>
                <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="hidePredictions()">
                    <i class="fas fa-times"></i> Close
                </button>
            `;
        });
}

function hidePredictions() {
    document.getElementById('mlPredictions').style.display = 'none';
}

// Auto-predict on form changes (optional)
let predictionTimeout;
function autoPredict() {
    clearTimeout(predictionTimeout);
    predictionTimeout = setTimeout(() => {
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        
        if (title.length > 10 && description.length > 20) {
            getMLPredictions();
        }
    }, 2000); // Wait 2 seconds after user stops typing
}

// Add event listeners for auto-prediction (uncomment to enable)
// document.getElementById('title').addEventListener('input', autoPredict);
// document.getElementById('description').addEventListener('input', autoPredict);
</script>
{% endblock %}

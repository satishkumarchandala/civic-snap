{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Hero Section -->
    {% if not session.user_id %}
    <section class="hero">
        <h1><i class="fas fa-city"></i> Urban Issue Reporter</h1>
        <p>Help make your city better by reporting and tracking urban issues</p>
        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
            <a href="{{ url_for('register') }}" class="btn" style="font-size: 1.2rem; padding: 1rem 2rem;">
                <i class="fas fa-rocket"></i> Get Started
            </a>
            <a href="{{ url_for('demo') }}" class="btn btn-demo" style="font-size: 1.2rem; padding: 1rem 2rem; background: #667eea; color: white;">
                <i class="fas fa-play-circle"></i> Try Demo
            </a>
        </div>
    </section>
    {% endif %}
    
    <!-- Statistics Section -->
    <section class="statistics-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-number">
                    {{ total_users }}
                </div>
                <div class="stat-label">
                    Registered Users
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="stat-number">
                    {{ total_issues }}
                </div>
                <div class="stat-label">
                    Total Issues Reported
                </div>
            </div>
        </div>
    </section>
    
    <!-- Filters Section -->
    <div class="filters">
        <h2><i class="fas fa-filter"></i> Filter Issues</h2>
        <form method="GET" class="filter-form">
            <div class="filter-row">
                <div class="filter-item">
                <label for="category"><i class="fas fa-tags"></i> Category</label>
                <select name="category" id="category" class="form-control">
                    <option value="">All Categories</option>
                    <option value="road" {{ 'selected' if current_category == 'road' }}>ğŸ›£ï¸ Road</option>
                    <option value="transport" {{ 'selected' if current_category == 'transport' }}>ï¿½ Transport</option>
                    <option value="sanitation" {{ 'selected' if current_category == 'sanitation' }}>ğŸ—‘ï¸ Sanitation</option>
                    <option value="infrastructure" {{ 'selected' if current_category == 'infrastructure' }}>ğŸ—ï¸ Infrastructure</option>
                    <option value="water" {{ 'selected' if current_category == 'water' }}>ğŸ’§ Water</option>
                    <option value="electricity" {{ 'selected' if current_category == 'electricity' }}>âš¡ Electricity</option>
                    <option value="environment" {{ 'selected' if current_category == 'environment' }}>ğŸŒ± Environment</option>
                    <option value="other" {{ 'selected' if current_category == 'other' }}>ğŸ“‹ Other</option>
                </select>
            </div>
            
            <div class="filter-item">
                <label for="status"><i class="fas fa-info-circle"></i> Status</label>
                <select name="status" id="status" class="form-control">
                    <option value="">All Status</option>
                    <option value="pending" {{ 'selected' if current_status == 'pending' }}>Pending</option>
                    <option value="in-progress" {{ 'selected' if current_status == 'in-progress' }}>In Progress</option>
                    <option value="resolved" {{ 'selected' if current_status == 'resolved' }}>Resolved</option>
                    <option value="rejected" {{ 'selected' if current_status == 'rejected' }}>Rejected</option>
                </select>
            </div>
            
            <div class="filter-item">
                <label for="search"><i class="fas fa-search"></i> Search</label>
                <input type="text" name="search" id="search" class="form-control" 
                       placeholder="Search issues..." value="{{ search_term or '' }}">
            </div>
            
                <div class="filter-item">
                    <button type="submit" class="btn btn-apply-filters">
                        <i class="fas fa-search"></i> Apply Filters
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Issues Grid -->
    <div class="card-grid">
        {% if issues %}
            {% for issue in issues %}
            <div class="card issue-card">
                <div class="issue-header">
                    <div>
                        <h3 class="issue-title">{{ issue.title }}</h3>
                        <div class="issue-meta">
                            <span class="badge badge-{{ issue.category }}">
                                {% if issue.category == 'road' %}ğŸ›£ï¸ Road
                                {% elif issue.category == 'transport' %}ï¿½ Transport
                                {% elif issue.category == 'sanitation' %}ğŸ—‘ï¸ Sanitation
                                {% elif issue.category == 'infrastructure' %}ğŸ—ï¸ Infrastructure
                                {% elif issue.category == 'water' %}ğŸ’§ Water
                                {% elif issue.category == 'electricity' %}âš¡ Electricity
                                {% elif issue.category == 'environment' %}ğŸŒ± Environment
                                {% else %}ğŸ“‹ Other{% endif %}
                            </span>
                            
                            <span class="badge badge-{{ issue.status }}">
                                {% if issue.status == 'pending' %}â³ Pending
                                {% elif issue.status == 'in-progress' %}ğŸ”„ In Progress
                                {% elif issue.status == 'resolved' %}âœ… Resolved
                                {% elif issue.status == 'rejected' %}âŒ Rejected
                                {% else %}{{ issue.status.title() }}{% endif %}
                            </span>
                            
                            <span class="badge" style="background: #f1c40f; color: #2c3e50;">
                                ğŸ“Š {{ issue.priority.title() }}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="issue-location">
                    <i class="fas fa-map-marker-alt"></i>
                    {{ issue.address }}
                </div>
                
                <div class="issue-description">
                    {{ issue.description[:150] }}{% if issue.description|length > 150 %}...{% endif %}
                </div>
                
                {% if issue.image_filename %}
                <div style="margin: 1rem 0;">
                    <img src="{{ url_for('uploaded_file', filename=issue.image_filename) }}" 
                         alt="Issue Image" 
                         style="max-width: 100%; height: 200px; object-fit: cover; border-radius: 10px;">
                </div>
                {% endif %}
                
                <div class="issue-actions">
                    <button class="upvote-btn" onclick="upvoteIssue('{{ issue.id }}')">
                        <i class="fas fa-thumbs-up"></i>
                        <span id="upvotes-{{ issue.id }}">{{ issue.upvotes }}</span>
                    </button>
                    
                    <a href="{{ url_for('issue_detail', issue_id=issue.id) }}" class="btn" style="font-size: 0.9rem;">
                        <i class="fas fa-eye"></i> View Details
                    </a>
                    
                    <small style="color: #666; margin-left: auto;">
                        <i class="fas fa-user"></i> {{ issue.reporter_name or 'Anonymous' }} |
                        <i class="fas fa-calendar"></i> {{ issue.created_at.strftime('%Y-%m-%d') if issue.created_at.strftime else issue.created_at|string|truncate(10, True, '') }}
                    </small>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="card" style="text-align: center; grid-column: 1/-1;">
                <i class="fas fa-search" style="font-size: 4rem; color: #ccc; margin-bottom: 1rem;"></i>
                <h2>No issues found</h2>
                <p style="color: #666; margin-bottom: 2rem;">
                    {% if session.user_id %}
                        Be the first to report an issue in your area!
                    {% else %}
                        Join our community to report and track urban issues.
                    {% endif %}
                </p>
                {% if session.user_id %}
                    <a href="{{ url_for('report_issue') }}" class="btn">
                        <i class="fas fa-plus-circle"></i> Report First Issue
                    </a>
                {% else %}
                    <a href="{{ url_for('register') }}" class="btn">
                        <i class="fas fa-user-plus"></i> Join Now
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function upvoteIssue(issueId) {
    {% if session.user_id %}
    try {
        const response = await fetch(`/upvote/${issueId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update the upvote count
            document.getElementById(`upvotes-${issueId}`).textContent = data.upvotes;
            // Disable the button
            const button = event.target.closest('button');
            if (button) {
                button.disabled = true;
                button.classList.add('upvoted');
                button.title = 'You have already upvoted this issue';
                // Brief visual feedback
                button.style.transform = 'scale(1.1)';
                setTimeout(() => button.style.transform = 'scale(1)', 200);
            }
        } else if (data.already_upvoted) {
            alert('You have already upvoted this issue!');
        } else {
            // Check if it's a profile completion error
            if (data.error && data.error.toLowerCase().includes('profile')) {
                if (confirm(data.error + '\n\nWould you like to complete your profile now?')) {
                    window.location.href = '/profile';
                }
            } else {
                alert(data.error || 'Failed to upvote. Please try again.');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while upvoting. Please try again.');
    }
    {% else %}
    alert('Please login to upvote issues!');
    {% endif %}
}
</script>
{% endblock %}

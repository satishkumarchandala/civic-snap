{% extends "base.html" %}

{% block title %}ML Model Management - Urban Issue Reporter{% endblock %}

{% block content %}
<div class="container">
    <div class="admin-header">
        <h1><i class="fas fa-robot"></i> ML Model Management</h1>
        <p class="text-muted">Manage and monitor machine learning automation</p>
    </div>

    <!-- Model Status Cards -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-circle {% if models_loaded.category_model %}bg-success{% else %}bg-warning{% endif %} me-3">
                            <i class="fas fa-tags text-white"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-1">Category Classification</h5>
                            <p class="text-muted mb-0">
                                {% if models_loaded.category_model %}
                                    <i class="fas fa-check-circle text-success"></i> Model Loaded
                                {% else %}
                                    <i class="fas fa-exclamation-triangle text-warning"></i> Using Rule-based Fallback
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-circle {% if models_loaded.priority_model %}bg-success{% else %}bg-warning{% endif %} me-3">
                            <i class="fas fa-exclamation-circle text-white"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-1">Priority Detection</h5>
                            <p class="text-muted mb-0">
                                {% if models_loaded.priority_model %}
                                    <i class="fas fa-check-circle text-success"></i> Model Loaded
                                {% else %}
                                    <i class="fas fa-exclamation-triangle text-warning"></i> Using Rule-based Fallback
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Training Data Statistics -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Training Data Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <h3 class="text-primary">{{ stats.total_issues }}</h3>
                            <p class="text-muted">Total Issues</p>
                        </div>
                        <div class="col-md-3 text-center">
                            <h3 class="text-warning">{{ stats.pending_issues }}</h3>
                            <p class="text-muted">Pending Issues</p>
                        </div>
                        <div class="col-md-3 text-center">
                            <h3 class="text-success">{{ stats.resolved_issues }}</h3>
                            <p class="text-muted">Resolved Issues</p>
                        </div>
                        <div class="col-md-3 text-center">
                            <h3 class="text-info">{{ stats.recent_issues|length }}</h3>
                            <p class="text-muted">Recent Issues</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ML Actions -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-graduation-cap"></i> Model Training</h5>
                </div>
                <div class="card-body">
                    <p>Retrain models with current issue data to improve accuracy.</p>
                    <form method="POST" action="{{ url_for('train_models') }}" onsubmit="return confirm('This may take several minutes. Continue?')">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-cogs"></i> Train Models
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-sync-alt"></i> Batch Update</h5>
                </div>
                <div class="card-body">
                    <p>Update existing issues with ML predictions where confidence is high.</p>
                    <form method="POST" action="{{ url_for('batch_update_with_ml') }}" onsubmit="return confirm('Update existing issues with ML predictions?')">
                        <button type="submit" class="btn btn-info">
                            <i class="fas fa-magic"></i> Batch Update
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-download"></i> Model Export</h5>
                </div>
                <div class="card-body">
                    <p>Export trained models for backup or deployment.</p>
                    <button class="btn btn-secondary" onclick="alert('Feature coming soon!')">
                        <i class="fas fa-file-export"></i> Export Models
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ML Testing Interface -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-flask"></i> Test ML Predictions</h5>
                </div>
                <div class="card-body">
                    <form id="mlTestForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="testTitle" class="form-label">Issue Title</label>
                                    <input type="text" class="form-control" id="testTitle" placeholder="e.g., Broken streetlight">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="testDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="testDescription" rows="3" placeholder="Describe the issue..."></textarea>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-brain"></i> Get ML Predictions
                        </button>
                    </form>

                    <div id="mlResults" class="mt-4" style="display: none;">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-robot"></i> ML Predictions</h6>
                            <div id="predictionResults"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Issues for Reference -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> Recent Issues (Training Examples)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for issue in stats.recent_issues[:10] %}
                                <tr>
                                    <td>
                                        <strong>{{ issue.title }}</strong>
                                        <br><small class="text-muted">{{ issue.description[:50] }}...</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ issue.category }}</span>
                                    </td>
                                    <td>
                                        <span class="badge {% if issue.priority == 'critical' %}bg-danger{% elif issue.priority == 'high' %}bg-warning{% elif issue.priority == 'low' %}bg-secondary{% else %}bg-info{% endif %}">
                                            {{ issue.priority }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge {% if issue.status == 'resolved' %}bg-success{% elif issue.status == 'in_progress' %}bg-warning{% else %}bg-secondary{% endif %}">
                                            {{ issue.status }}
                                        </span>
                                    </td>
                                    <td>{{ issue.created_at.split(' ')[0] if issue.created_at else 'N/A' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.icon-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.admin-header {
    margin-bottom: 2rem;
    text-align: center;
}

.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: none;
    margin-bottom: 1rem;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}
</style>

<script>
document.getElementById('mlTestForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const title = document.getElementById('testTitle').value;
    const description = document.getElementById('testDescription').value;
    
    if (!title || !description) {
        alert('Please provide both title and description');
        return;
    }
    
    // Show loading
    const resultsDiv = document.getElementById('mlResults');
    const predictionDiv = document.getElementById('predictionResults');
    resultsDiv.style.display = 'block';
    predictionDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting ML predictions...';
    
    // Make API call
    fetch(`/api/ml/predict?title=${encodeURIComponent(title)}&description=${encodeURIComponent(description)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const predictions = data.predictions;
                predictionDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Category:</strong> ${predictions.category.category}<br>
                            <small>Confidence: ${(predictions.category.confidence * 100).toFixed(1)}%</small><br>
                            <small>Method: ${predictions.category.method}</small>
                        </div>
                        <div class="col-md-6">
                            <strong>Priority:</strong> ${predictions.priority.priority}<br>
                            <small>Confidence: ${(predictions.priority.confidence * 100).toFixed(1)}%</small><br>
                            <small>Method: ${predictions.priority.method}</small>
                        </div>
                    </div>
                    ${predictions.explanation && predictions.explanation.category_reasoning.length > 0 ? 
                        '<div class="mt-3"><strong>Reasoning:</strong><ul>' + 
                        predictions.explanation.category_reasoning.map(r => '<li>' + r + '</li>').join('') +
                        predictions.explanation.priority_reasoning.map(r => '<li>' + r + '</li>').join('') +
                        '</ul></div>' : ''
                    }
                `;
            } else {
                predictionDiv.innerHTML = '<div class="text-danger">Error: ' + data.error + '</div>';
            }
        })
        .catch(error => {
            predictionDiv.innerHTML = '<div class="text-danger">Error: ' + error.message + '</div>';
        });
});
</script>

{% endblock %}
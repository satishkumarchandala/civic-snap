{% extends "base.html" %}

{% block title %}{{ issue.title }} - Urban Issue Reporter{% endblock %}

{% block content %}
<div class="container">
    <div style="max-width: 1000px; margin: 2rem auto;">
        <!-- Back Button -->
        <a href="{{ url_for('index') }}" class="btn" style="margin-bottom: 2rem;">
            <i class="fas fa-arrow-left"></i> Back to Issues
        </a>
        
        <!-- Issue Details -->
        <div class="card">
            <div class="issue-header">
                <div>
                    <h1 class="issue-title">{{ issue.title }}</h1>
                    <div class="issue-meta">
                        <span class="badge badge-{{ issue.category }}">
                            {% if issue.category == 'road' %}üõ£Ô∏è Road
                            {% elif issue.category == 'transport' %}ÔøΩ Transport
                            {% elif issue.category == 'sanitation' %}üóëÔ∏è Sanitation
                            {% elif issue.category == 'infrastructure' %}üèóÔ∏è Infrastructure
                            {% elif issue.category == 'water' %}üíß Water
                            {% elif issue.category == 'electricity' %}‚ö° Electricity
                            {% elif issue.category == 'environment' %}üå± Environment
                            {% else %}üìã Other{% endif %}
                        </span>
                        
                        <span class="badge badge-{{ issue.status }}">
                            {% if issue.status == 'pending' %}‚è≥ Pending
                            {% elif issue.status == 'in-progress' %}üîÑ In Progress
                            {% elif issue.status == 'resolved' %}‚úÖ Resolved
                            {% elif issue.status == 'rejected' %}‚ùå Rejected
                            {% else %}{{ issue.status.title() }}{% endif %}
                        </span>
                        
                        <span class="badge" style="background: #f1c40f; color: #2c3e50;">
                            üìä {{ issue.priority.title() }} Priority
                        </span>
                        
                        <!-- Enhanced Priority Score -->
                        {% if issue.priority_score %}
                        <span class="priority-score-badge priority-{{ issue.priority_level or 'medium' }}">
                            üéØ {{ "%.1f" | format(issue.priority_score) }} Priority Score
                        </span>
                        {% endif %}
                    </div>
                    
                    <!-- Priority Breakdown -->
                    {% if issue.priority_breakdown %}
                    <div class="priority-breakdown-summary">
                        {% set breakdown = issue.priority_breakdown | from_json %}
                        <h4><i class="fas fa-chart-line"></i> Priority Analysis</h4>
                        <div class="priority-factors">
                            <div class="factor-summary">
                                <span class="factor-name">Severity</span>
                                <div class="factor-bar">
                                    <div class="factor-fill" style="width: {{ (breakdown.factor_scores.severity/10*100) }}%"></div>
                                </div>
                                <span class="factor-value">{{ "%.1f" | format(breakdown.factor_scores.severity) }}</span>
                            </div>
                            <div class="factor-summary">
                                <span class="factor-name">Location</span>
                                <div class="factor-bar">
                                    <div class="factor-fill" style="width: {{ (breakdown.factor_scores.location/10*100) }}%"></div>
                                </div>
                                <span class="factor-value">{{ "%.1f" | format(breakdown.factor_scores.location) }}</span>
                            </div>
                            <div class="factor-summary">
                                <span class="factor-name">Reports</span>
                                <div class="factor-bar">
                                    <div class="factor-fill" style="width: {{ (breakdown.factor_scores.reports_count/10*100) }}%"></div>
                                </div>
                                <span class="factor-value">{{ "%.1f" | format(breakdown.factor_scores.reports_count) }}</span>
                            </div>
                            <div class="factor-summary">
                                <span class="factor-name">Age</span>
                                <div class="factor-bar">
                                    <div class="factor-fill" style="width: {{ (breakdown.factor_scores.age/10*100) }}%"></div>
                                </div>
                                <span class="factor-value">{{ "%.1f" | format(breakdown.factor_scores.age) }}</span>
                            </div>
                            <div class="factor-summary">
                                <span class="factor-name">Safety</span>
                                <div class="factor-bar">
                                    <div class="factor-fill" style="width: {{ (breakdown.factor_scores.safety_impact/10*100) }}%"></div>
                                </div>
                                <span class="factor-value">{{ "%.1f" | format(breakdown.factor_scores.safety_impact) }}</span>
                            </div>
                        </div>
                        
                        {% if breakdown.duplicate_count > 0 %}
                        <div class="duplicate-notice">
                            <i class="fas fa-copy"></i> {{ breakdown.duplicate_count }} similar reports found nearby
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                </div>
                
                <!-- Admin Actions -->
                {% if session.is_admin %}
                <div style="margin-left: auto;">
                    <button class="btn btn-warning" onclick="showStatusModal()">
                        <i class="fas fa-edit"></i> Update Status
                    </button>
                </div>
                {% endif %}
            </div>
            
            <div class="issue-location">
                <i class="fas fa-map-marker-alt"></i>
                {{ issue.address }}
                <span style="color: #000; margin-left: 1rem;">
                    ({{ "%.6f"|format(issue.latitude) }}, {{ "%.6f"|format(issue.longitude) }})
                </span>
            </div>
            
            <div class="issue-description" style="font-size: 1.1rem; line-height: 1.7; margin: 2rem 0;">
                {{ issue.description }}
            </div>
            
            {% if issue.image_filename %}
            <div style="margin: 2rem 0;">
                <img src="{{ url_for('uploaded_file', filename=issue.image_filename) }}" 
                     alt="Issue Image" 
                     style="max-width: 100%; height: auto; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
            </div>
            {% endif %}
            
            <!-- Map -->
            <div id="map" class="map-container"></div>
            
            <div class="issue-actions" style="border-top: 1px solid #eee; padding-top: 1.5rem; margin-top: 1.5rem;">
                {% if session.user_id %}
                    {% if user_has_upvoted %}
                    <button class="upvote-btn upvoted" disabled title="You have already upvoted this issue">
                        <i class="fas fa-thumbs-up"></i>
                        <span id="upvotes-{{ issue.id }}">{{ issue.upvotes }}</span> Already Upvoted
                    </button>
                    {% else %}
                    <button class="upvote-btn" onclick="upvoteIssue('{{ issue.id }}')" title="Click to upvote this issue">
                        <i class="fas fa-thumbs-up"></i>
                        <span id="upvotes-{{ issue.id }}">{{ issue.upvotes }}</span> Upvotes
                    </button>
                    {% endif %}
                {% else %}
                    <button class="upvote-btn" disabled title="Please login to upvote">
                        <i class="fas fa-thumbs-up"></i>
                        <span id="upvotes-{{ issue.id }}">{{ issue.upvotes }}</span> Upvotes
                    </button>
                {% endif %}
                
                <div style="margin-left: auto; color: #000;">
                    <i class="fas fa-user"></i> Reported by: {{ issue.reporter_name or 'Anonymous' }} |
                    <i class="fas fa-calendar"></i> {{ issue.created_at.strftime('%Y-%m-%d %H:%M:%S') if issue.created_at.strftime else issue.created_at|string|truncate(19, True, '') }}
                </div>
            </div>
        </div>
        
        <!-- Comments Section -->
        <div class="card" style="margin-top: 2rem;">
            <h2 style="margin-bottom: 2rem;">
                <i class="fas fa-comments"></i> Community Discussion ({{ comments|length }})
            </h2>
            
            <!-- Add Comment Form -->
            {% if session.user_id %}
                {% if session.profile_complete %}
                    <form method="POST" action="{{ url_for('add_comment', issue_id=issue.id) }}" style="margin-bottom: 3rem;">
                        <div class="form-group">
                            <textarea name="content" class="form-control textarea" 
                                      placeholder="Share your thoughts or provide updates..." required></textarea>
                        </div>
                        <button type="submit" class="btn">
                            <i class="fas fa-paper-plane"></i> Post Comment
                        </button>
                    </form>
                {% else %}
                    <div style="text-align: center; padding: 2rem; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 10px; margin-bottom: 3rem;">
                        <p style="margin-bottom: 1rem; color: #856404;">
                            <i class="fas fa-user-edit"></i> Complete your profile to join the discussion
                        </p>
                        <a href="{{ url_for('profile') }}" class="btn" style="background: #ff9800;">
                            <i class="fas fa-edit"></i> Complete Profile
                        </a>
                    </div>
                {% endif %}
            {% else %}
            <div style="text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 10px; margin-bottom: 3rem;">
                <p style="margin-bottom: 1rem; color: #000;">Please login to join the discussion</p>
                <a href="{{ url_for('login') }}" class="btn">
                    <i class="fas fa-sign-in-alt"></i> Login to Comment
                </a>
            </div>
            {% endif %}
            
            <!-- Comments List -->
            {% if comments %}
                {% for comment in comments %}
                <div class="comment" style="border-left: 4px solid {{ '#667eea' if comment.is_official else '#ddd' }}; 
                                                 padding: 1.5rem; margin-bottom: 1.5rem; 
                                                 background: {{ '#f0f4ff' if comment.is_official else '#f9f9f9' }}; 
                                                 border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <strong>{{ comment.user_name }}</strong>
                            {% if comment.is_official %}
                                <span class="badge" style="background: #667eea; color: white; margin-left: 0.5rem;">
                                    <i class="fas fa-shield-alt"></i> Official
                                </span>
                            {% endif %}
                        </div>
                        <small style="color: #000;">
                            <i class="fas fa-clock"></i> {{ comment.created_at.strftime('%Y-%m-%d %H:%M:%S') if comment.created_at.strftime else comment.created_at|string|truncate(19, True, '') }}
                        </small>
                    </div>
                    <p style="margin: 0; line-height: 1.6; color: #000;">{{ comment.content }}</p>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 3rem; color: #000;">
                    <i class="fas fa-comment" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                    <p>No comments yet. Be the first to share your thoughts!</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Status Update Modal (Admin Only) -->
{% if session.is_admin %}
<div id="statusModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                               background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 2rem; border-radius: 20px; max-width: 500px; width: 90%;">
        <h3 style="margin-bottom: 1.5rem;">
            <i class="fas fa-edit"></i> Update Issue Status
        </h3>
        <form method="POST" action="{{ url_for('update_status', issue_id=issue.id) }}">
            <div class="form-group">
                <label for="status">New Status</label>
                <select name="status" id="status" class="form-control" required>
                    <option value="pending" {{ 'selected' if issue.status == 'pending' }}>‚è≥ Pending</option>
                    <option value="in-progress" {{ 'selected' if issue.status == 'in-progress' }}>üîÑ In Progress</option>
                    <option value="resolved" {{ 'selected' if issue.status == 'resolved' }}>‚úÖ Resolved</option>
                    <option value="rejected" {{ 'selected' if issue.status == 'rejected' }}>‚ùå Rejected</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="comment">Update Comment (Optional)</label>
                <textarea name="comment" id="comment" class="form-control textarea" 
                          placeholder="Provide additional information about this status update..."></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn" style="background: #ccc;" onclick="hideStatusModal()">
                    Cancel
                </button>
                <button type="submit" class="btn">
                    <i class="fas fa-save"></i> Update Status
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Initialize map
let map = L.map('map').setView([{{ issue.latitude }}, {{ issue.longitude }}], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.marker([{{ issue.latitude }}, {{ issue.longitude }}]).addTo(map)
    .bindPopup('{{ issue.title }}')
    .openPopup();

// Upvote function
async function upvoteIssue(issueId) {
    {% if session.user_id %}
    try {
        const response = await fetch(`/upvote/${issueId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update the upvote count and disable button
            const button = document.querySelector(`button[onclick="upvoteIssue('${issueId}')"]`);
            button.innerHTML = `<i class="fas fa-thumbs-up"></i> <span id="upvotes-${issueId}">${data.upvotes}</span> Already Upvoted`;
            button.disabled = true;
            button.classList.add('upvoted');
            button.title = 'You have already upvoted this issue';
            button.removeAttribute('onclick');
            
            // Brief visual feedback
            button.style.transform = 'scale(1.1)';
            setTimeout(() => button.style.transform = 'scale(1)', 200);
        } else if (data.already_upvoted) {
            alert('You have already upvoted this issue!');
        } else {
            // Check if it's a profile completion error
            if (data.error && data.error.toLowerCase().includes('profile')) {
                if (confirm(data.error + '\n\nWould you like to complete your profile now?')) {
                    window.location.href = '/profile';
                }
            } else {
                alert(data.error || 'Failed to upvote. Please try again.');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while upvoting. Please try again.');
    }
    {% else %}
    alert('Please login to upvote issues!');
    {% endif %}
}

{% if session.is_admin %}
function showStatusModal() {
    document.getElementById('statusModal').style.display = 'flex';
}

function hideStatusModal() {
    document.getElementById('statusModal').style.display = 'none';
}
{% endif %}
</script>
{% endblock %}
